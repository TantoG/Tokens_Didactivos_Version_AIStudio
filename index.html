<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guía Didáctica de Tokens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #020617; /* slate-950 */
        color: #f8fafc; /* slate-50 */
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.3?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
        "@google/genai": "https://esm.sh/@google/genai"
      }
    }
    </script>

    <script>
      // Polyfill for process.env. 
      // NOTE: In production, never hardcode keys in client-side code.
      // Setting API_KEY here as requested for testing purposes.
      window.process = { 
        env: { 
          API_KEY: 'AIzaSyDpt8P3pmPyq4eu1UMLOtF3b-lbA23pFAI' 
        } 
      };
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- Application Code -->
    <script type="text/babel" data-type="module" data-presets="react">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, LabelList
      } from 'recharts';
      import { 
        BookOpen, Scale, Languages, BarChart3 as ChartColumn, 
        RefreshCw, Info, ArrowRightLeft, Loader2, 
        Coins, Cpu, Database, Video, Box, Globe 
      } from 'lucide-react';
      import { GoogleGenAI, Type } from "@google/genai";

      // --- CONFIGURATION & CONSTANTS ---
      const GEMINI_MODEL = 'gemini-3-flash-preview';
      
      const STAGES = [
        { id: 'anatomy', title: '1. Anatomía', subtitle: '¿Qué es un Token?', icon: Scale },
        { id: 'inequity', title: '2. Inequidad', subtitle: 'Sesgo del Idioma', icon: Languages },
        { id: 'asymmetry', title: '3. Asimetría', subtitle: 'Entrada vs Salida', icon: ChartColumn }
      ];

      // --- SERVICES ---
      // Initialized using the key from process.env (configured in the head script)
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

      // --- COMPONENTS ---

      // 1. ANATOMY COMPONENT
      const Stage1Anatomy = () => {
        const [text, setText] = useState("El arte digital requiere tokens");
        const [tokens, setTokens] = useState({ word: [], char: [], bpe: [] });

        useEffect(() => {
          // Simulation logic
          const word = text.split(/(\s+|[.,;!?])/).filter(t => t.trim().length > 0);
          
          const char = [];
          for (let i = 0; i < text.length; i += 4) char.push(text.slice(i, i + 4));
          
          // Simplified BPE simulation
          const bpe = [];
          text.split(' ').forEach(w => {
            if (w.length > 5) {
               const m = Math.floor(w.length/2); 
               bpe.push(w.slice(0, m)); 
               bpe.push(w.slice(m)); 
            } else { bpe.push(w); }
          });

          setTokens({ word, char, bpe });
        }, [text]);

        const Card = ({ title, data, color, recom }) => (
          <div className={`bg-slate-900 rounded-xl border ${recom ? 'border-green-500/50 ring-1 ring-green-500/30' : 'border-slate-800'} p-4 flex flex-col h-full`}>
            <div className="flex justify-between items-start mb-3">
              <h3 className="font-bold text-slate-200">{title}</h3>
              {recom && <span className="bg-green-900/50 text-green-300 text-[10px] px-2 py-0.5 rounded uppercase font-bold">Estándar</span>}
            </div>
            <div className="flex-1 flex flex-wrap gap-1 content-start mb-4">
              {data.map((t, i) => (
                <span key={i} className={`px-2 py-1 rounded text-xs font-mono border ${color} bg-opacity-20`}>{t}</span>
              ))}
            </div>
            <div className="text-right text-xs text-slate-500 font-mono border-t border-slate-800 pt-2">
              Count: <span className="text-white font-bold">{data.length}</span>
            </div>
          </div>
        );

        return (
          <div className="animate-fade-in space-y-6">
            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
              <label className="text-slate-400 text-sm mb-2 block">Prueba el Tokenizador:</label>
              <textarea 
                value={text} onChange={e => setText(e.target.value)}
                className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none h-24 font-mono"
              />
            </div>
            <div className="grid md:grid-cols-3 gap-4">
              <Card title="Palabra Completa" data={tokens.word} color="border-red-500/30 bg-red-500/10 text-red-200" />
              <Card title="Caracteres (4)" data={tokens.char} color="border-yellow-500/30 bg-yellow-500/10 text-yellow-200" />
              <Card title="Sub-palabra (BPE)" data={tokens.bpe} color="border-green-500/30 bg-green-500/10 text-green-200" recom />
            </div>
             <div className="bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded text-blue-200 text-sm">
                <Info className="inline w-4 h-4 mr-2"/>
                Los LLMs modernos usan <strong>BPE</strong>. Es el equilibrio perfecto entre vocabulario manejable y capacidad de entender palabras nuevas.
             </div>
          </div>
        );
      };

      // 2. INEQUITY COMPONENT
      const Stage2Inequity = () => {
        const [inputText, setInputText] = useState("La inteligencia artificial está transformando el mundo rápidamente.");
        const [loading, setLoading] = useState(false);
        const [results, setResults] = useState(null);
        const [chartData, setChartData] = useState([
          { lang: 'Inglés', tokens: 7, fill: '#6366f1' },
          { lang: 'Español', tokens: 9, fill: '#f43f5e' },
          { lang: 'Chino', tokens: 6, fill: '#10b981' }
        ]);

        const analyzeText = async () => {
          if (!inputText.trim()) return;
          setLoading(true);
          try {
            const response = await ai.models.generateContent({
              model: GEMINI_MODEL,
              contents: `Analyze the following text: "${inputText}". 
              1. Translate it into English and Simplified Chinese.
              2. Return the translated strings.
              3. Estimate the number of tokens each version (Original Spanish, English, Chinese) would consume in a standard LLM tokenizer (like cl100k_base).
              `,
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    original: {
                      type: Type.OBJECT,
                      properties: {
                        language: { type: Type.STRING },
                        text: { type: Type.STRING },
                        token_count: { type: Type.NUMBER }
                      }
                    },
                    english: {
                      type: Type.OBJECT,
                      properties: {
                        text: { type: Type.STRING },
                        token_count: { type: Type.NUMBER }
                      }
                    },
                    chinese: {
                      type: Type.OBJECT,
                      properties: {
                        text: { type: Type.STRING },
                        token_count: { type: Type.NUMBER }
                      }
                    }
                  }
                }
              }
            });

            const json = JSON.parse(response.text);
            
            setResults(json);
            setChartData([
               { lang: 'Inglés', tokens: json.english.token_count, fill: '#6366f1' },
               { lang: 'Español', tokens: json.original.token_count, fill: '#f43f5e' }, 
               { lang: 'Chino', tokens: json.chinese.token_count, fill: '#10b981' }   
            ]);
            
          } catch (error) {
            console.error("Error generating analysis", error);
            alert("Error al conectar con Gemini. Verifica tu API Key.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="animate-fade-in grid lg:grid-cols-2 gap-8 h-full">
            <div className="space-y-6 flex flex-col">
              <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 flex-1 flex flex-col">
                <h3 className="text-xl font-bold text-slate-100 mb-2">La "Multa" del Idioma</h3>
                <p className="text-slate-400 mb-4 text-sm">
                  Escribe una frase en español. La traduciremos y compararemos cuántos tokens cuesta decir lo mismo en otros idiomas.
                </p>
                
                <textarea 
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none h-32 font-mono resize-none mb-4"
                  placeholder="Escribe algo aquí..."
                />

                <button 
                  onClick={analyzeText} 
                  disabled={loading}
                  className="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold flex justify-center items-center transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? <Loader2 className="animate-spin mr-2"/> : <RefreshCw className="mr-2"/>}
                  {loading ? "Analizando..." : "Analizar y Traducir"}
                </button>
              </div>

              {results && (
                <div className="grid gap-3">
                  <div className="bg-slate-800/50 p-3 rounded border border-slate-700 border-l-4 border-l-indigo-500">
                    <div className="text-[10px] text-indigo-300 uppercase font-bold mb-1">Inglés (Traducción)</div>
                    <div className="text-slate-300 text-sm">{results.english.text}</div>
                  </div>
                  <div className="bg-slate-800/50 p-3 rounded border border-slate-700 border-l-4 border-l-emerald-500">
                    <div className="text-[10px] text-emerald-300 uppercase font-bold mb-1">Chino (Traducción)</div>
                    <div className="text-slate-300 text-sm">{results.chinese.text}</div>
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex flex-col gap-4">
              <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex-1 min-h-[300px]">
                <h4 className="text-sm font-semibold text-slate-400 mb-4 text-center">Costo de Tokens por Idioma</h4>
                <ResponsiveContainer width="100%" height="90%">
                  <BarChart data={chartData} layout="vertical" margin={{top: 5, right: 30, left: 20, bottom: 5}}>
                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#334155" />
                    <XAxis type="number" hide />
                    <YAxis dataKey="lang" type="category" width={60} stroke="#94a3b8" fontSize={12} tick={{fill: '#94a3b8'}} />
                    <Tooltip 
                      cursor={{fill: 'rgba(255,255,255,0.05)'}} 
                      contentStyle={{background: '#1e293b', border: '1px solid #334155', color:'#fff', borderRadius: '8px'}} 
                    />
                    <Bar dataKey="tokens" radius={[0, 4, 4, 0]} barSize={40}>
                      <LabelList dataKey="tokens" position="right" fill="#fff" fontWeight="bold" />
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
              
               <div className="bg-amber-900/20 border border-amber-500/30 p-4 rounded-xl">
                  <div className="flex items-start gap-3">
                    <Globe className="w-5 h-5 text-amber-500 mt-1 shrink-0" />
                    <div>
                      <h4 className="text-amber-200 font-bold text-sm mb-1">¿Por qué sucede esto?</h4>
                      <p className="text-amber-100/70 text-xs leading-relaxed">
                        Los tokenizadores están entrenados mayoritariamente con datos en inglés. Las palabras en inglés suelen ser 1 token. En español, a veces se dividen en 2. En chino, un solo caracter (token) carga mucho significado.
                      </p>
                    </div>
                  </div>
               </div>
            </div>
          </div>
        );
      };

      // 3. ASYMMETRY COMPONENT
      const Stage3Asymmetry = () => {
        const [input, setInput] = useState(1000);
        const [output, setOutput] = useState(100);
        
        const costIn = input * 0.0001; 
        const costOut = output * 0.0004; 
        const total = costIn + costOut;

        return (
          <div className="animate-fade-in space-y-8">
            <div className="bg-gradient-to-r from-indigo-900 to-slate-900 p-8 rounded-2xl border border-indigo-500/30 relative overflow-hidden">
               <div className="relative z-10">
                 <h2 className="text-2xl font-bold text-white mb-2">Entrada vs. Salida</h2>
                 <p className="text-indigo-200 max-w-lg">
                   Generar texto (output) es computacionalmente mucho más caro que leerlo (input).
                 </p>
               </div>
               <Video className="absolute right-4 bottom-4 w-32 h-32 text-indigo-500/10" />
            </div>

            <div className="grid md:grid-cols-2 gap-8 bg-slate-900 p-6 rounded-xl border border-slate-800">
               <div className="space-y-6">
                 <div>
                   <label className="flex justify-between text-sm text-slate-400 mb-2">
                     Tokens de Entrada (Prompt) <span className="text-white">{input}</span>
                   </label>
                   <input type="range" min="100" max="5000" step="100" value={input} onChange={e=>setInput(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                 </div>
                 <div>
                   <label className="flex justify-between text-sm text-slate-400 mb-2">
                     Tokens de Salida (Generación) <span className="text-white">{output}</span>
                   </label>
                   <input type="range" min="10" max="1000" step="10" value={output} onChange={e=>setOutput(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-rose-500"/>
                 </div>
               </div>

               <div className="flex flex-col justify-center space-y-4">
                  <div className="flex items-center justify-between p-3 bg-slate-800/50 rounded border border-slate-700">
                    <div className="flex items-center text-sky-400"><Cpu size={16} className="mr-2"/> Entrada</div>
                    <div className="font-mono text-white">${costIn.toFixed(4)}</div>
                  </div>
                  <div className="flex items-center justify-between p-3 bg-slate-800/50 rounded border border-slate-700">
                    <div className="flex items-center text-rose-400"><Database size={16} className="mr-2"/> Salida</div>
                    <div className="font-mono text-white">${costOut.toFixed(4)}</div>
                  </div>
                  <div className="border-t border-slate-700 pt-3 flex justify-between items-center">
                    <span className="text-slate-400 uppercase text-xs font-bold">Costo Total</span>
                    <span className="text-2xl font-bold text-white">${total.toFixed(4)}</span>
                  </div>
               </div>
            </div>
          </div>
        );
      };

      // MAIN APP SHELL
      const App = () => {
        const [stage, setStage] = useState('anatomy');

        return (
          <div className="flex flex-col md:flex-row min-h-screen">
            <aside className="w-full md:w-72 bg-slate-900 border-r border-slate-800 flex flex-col md:h-screen sticky top-0 z-20">
              <div className="p-6 flex items-center border-b border-slate-800">
                <div className="bg-indigo-600 p-2 rounded-lg text-white mr-3 shadow-lg shadow-indigo-500/20">
                  <BookOpen size={20} />
                </div>
                <div>
                  <h1 className="font-bold text-slate-100">Tokens 101</h1>
                  <p className="text-xs text-slate-500">Guía Interactiva</p>
                </div>
              </div>
              <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                {STAGES.map(s => (
                  <button 
                    key={s.id} 
                    onClick={() => setStage(s.id)}
                    className={`w-full flex items-center p-3 rounded-lg text-left transition ${stage === s.id ? 'bg-indigo-900/20 text-indigo-300 border border-indigo-500/30' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200 border border-transparent'}`}
                  >
                    <s.icon size={18} className="mr-3 opacity-70" />
                    <div>
                      <div className="text-sm font-semibold">{s.title}</div>
                      <div className="text-[10px] opacity-60">{s.subtitle}</div>
                    </div>
                  </button>
                ))}
              </nav>
            </aside>
            <main className="flex-1 bg-slate-950 p-4 md:p-8 lg:p-12 overflow-y-auto h-screen">
              <div className="max-w-4xl mx-auto">
                {stage === 'anatomy' && <Stage1Anatomy />}
                {stage === 'inequity' && <Stage2Inequity />}
                {stage === 'asymmetry' && <Stage3Asymmetry />}
              </div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>